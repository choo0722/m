<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>ç«‹å†¬</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>

<body>
  <div id="popup-layer"></div>

  <div class="modal-backdrop" id="start-modal">
    <div class="modal">
      <div class="titlebar">
        <span class="icon">â„ï¸</span>
        <span class="title">Toï¼š xxx</span>
      </div>
      <div class="content">
        ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼ŒæŸ¥çœ‹æ¸©é¦¨æç¤º~
      </div>
      <div class="actions">
        <button class="btn primary" onclick="startPopupEffect()">å¼€å§‹å±•ç¤º</button>
      </div>
    </div>
  </div>

  <audio id="localMusic" loop preload="auto">
    <source src="music.mp3" type="audio/mpeg"> æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
  </audio>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <script>
    let pyodide;
    const localMusic = document.getElementById('localMusic'); // è·å–éŸ³ä¹å…ƒç´ 

    // åˆå§‹åŒ–Pyodide
    async function initPyodide() {
      pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
      console.log("Pyodideåˆå§‹åŒ–å®Œæˆ");
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– 
    window.onload = initPyodide;

    // å¼€å§‹å¼¹çª—æ•ˆæœ
    async function startPopupEffect() {
      // éšè—å…¥åœºæ¨¡æ€æ¡†
      document.getElementById("start-modal").style.display = "none";
      // æ¸…é™¤ç°æœ‰å¼¹çª—
      resetPopups();

      // æ’­æ”¾æœ¬åœ°éŸ³ä¹
      playLocalMusic();

      // è·å–æµè§ˆå™¨çª—å£å°ºå¯¸
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      // å¼¹çª—å®¹å™¨
      const popupLayer = document.getElementById("popup-layer");

      // === ä¼˜åŒ–éƒ¨åˆ†å¼€å§‹ ===
      // åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯ (å®½åº¦å°äº768pxè§†ä¸ºç§»åŠ¨ç«¯)
      const isMobile = windowWidth < 768;

      // ç§»åŠ¨ç«¯æ”¾å¤§æ¯”ä¾‹ 1.4å€ï¼Œç”µè„‘ç«¯ä¿æŒ 1.0
      const scaleRatio = isMobile ? 1.4 : 1.0;

      // ç§»åŠ¨ç«¯æ•°é‡å‡å°‘é˜²æ­¢æ‹¥æŒ¤ (æ‰‹æœº60ä¸ªï¼Œç”µè„‘150ä¸ª)
      const popupCount = isMobile ? 100 : 150;

      // è®¡ç®—å³ä¾§å®‰å…¨è·ç¦» (åŸºç¡€å®½åº¦230px * ç¼©æ”¾æ¯”ä¾‹ï¼Œé˜²æ­¢æ”¾å¤§åæº¢å‡ºå±å¹•)
      //const safeMarginRight = Math.floor(230 * scaleRatio);
      // === ä¼˜åŒ–éƒ¨åˆ†ç»“æŸ ===

      // Pythonä»£ç ï¼šç”Ÿæˆå¼¹çª—å‚æ•°
      const pythonCode = `
        import random

        # çª—å£å°ºå¯¸
        width = ${windowWidth}
        height = ${windowHeight}

        # æç¤ºæ–‡å­—åˆ—è¡¨
        texts = [    'è®°å¾—åŠ è¡£ï¼',    'è®°å¾—ç…§é¡¾å¥½è‡ªå·±',    'å¤©å¤©å¼€å¿ƒ',    'å¥½å¥½åƒé¥­',    'æ—©ç‚¹ä¼‘æ¯',    'åˆ«æ„Ÿå†’',    'è¦ç›¸ä¿¡è‡ªå·±å¥¥',
            'æ„¿æ‰€æœ‰çƒ¦æ¼éƒ½æ¶ˆå¤±',    'æ¯å¤©éƒ½è¦å…ƒæ°”æ»¡æ»¡',    'ä¿æŒå¾®ç¬‘å‘€',    'é¡ºé¡ºåˆ©åˆ©',    'é‡‘æ¦œé¢˜å',    'æœŸå¾…ä¸‹ä¸€æ¬¡è§é¢',
            'å¥½å¥½çˆ±è‡ªå·±',    'çæƒœæ¯ä¸€åˆ»',    'åˆ«ç†¬å¤œ',    'å­¦ä¼šçˆ±è‡ªå·±',    'ä½ è¶…æ£’çš„',    'ä¿æŒå¥½å¿ƒæƒ…',    'å¤šå–æ¸©æ°´å“¦']
 

        # å¼¹çª—ä¸»é¢˜
        themes = [
            'theme-blue', 'theme-green', 'theme-orange', 'theme-purple', 'theme-pink',
            'theme-yellow', 'theme-cyan', 'theme-lime', 'theme-red', 'theme-teal',
            'theme-indigo', 'theme-amber', 'theme-rose', 'theme-mint', 'theme-peach',
            'theme-lavender', 'theme-coral', 'theme-sky', 'theme-lemon'
        ]

        # å¼¹çª—åŠ¨ç”»
        animations = [
            'anim-top', 'anim-bottom', 'anim-left', 'anim-right',
            'anim-topleft', 'anim-topright', 'anim-bottomleft', 'anim-bottomright'
        ]

        # ç”Ÿæˆå¼¹çª—å‚æ•° (ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„æ•°é‡)
        popup_params = []
        for _ in range(${popupCount}):
            # éšæœºä½ç½® (ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„å®‰å…¨è¾¹è·)
            # éšæœºä½ç½®ï¼ˆé€‚é…çª—å£å°ºå¯¸ï¼Œé¿å…å¼¹çª—è¶…å‡ºå±å¹•ï¼‰
            x = random.randint(0, width)
            y = random.randint(0, height)
            
            text = random.choice(texts)
            theme = random.choice(themes)
            anim = random.choice(animations)
            popup_params.append((x, y, text, theme, anim))

        popup_params
                    `;

      // æ‰§è¡ŒPythonä»£ç å¹¶è½¬æ¢ä¸ºJSæ•°ç»„
      const pythonResult = await pyodide.runPythonAsync(pythonCode);
      const popupParams = Array.from(pythonResult);

      // åˆ›å»ºå¼¹çª—å¹¶æ·»åŠ åˆ°å®¹å™¨
      popupParams.forEach(([x, y, text, theme, anim], index) => {
        setTimeout(() => {
          const popup = document.createElement('div');
          // åº”ç”¨æ ·å¼ç±»
          popup.className = `popup ${theme} ${anim}`;

          // è®¾ç½®ä½ç½®
          popup.style.left = `${x}px`;
          popup.style.top = `${y}px`;

          // === å…³é”®ä¼˜åŒ–ï¼šä½¿ç”¨transformæ”¾å¤§ï¼Œä¸æ”¹å˜CSSç±» ===
          if (isMobile) {
            popup.style.transform = `scale(${scaleRatio})`;
            popup.style.transformOrigin = 'top left'; // ä¿è¯æ”¾å¤§åä½ç½®åç§»å¯æ§
          }

          // å¼¹çª—å†…å®¹
          popup.innerHTML = `
                        <div class="header">
                            <span class="icon">ğŸ’–</span>
                            <span class="title">Toï¼šxxx</span>
                        </div>
                        <div class="content">${text}</div>
                    `;
          // æ·»åŠ åˆ°å®¹å™¨
          popupLayer.appendChild(popup);
        }, index * 100);
      });
    }

    // æ’­æ”¾æœ¬åœ°éŸ³ä¹
    function playLocalMusic() {
      localMusic.play().catch(err => {
        console.log("è‡ªåŠ¨æ’­æ”¾éœ€è¦ç”¨æˆ·äº¤äº’ï¼Œç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®ç»§ç»­...");
        document.body.addEventListener('click', () => {
          localMusic.play();
        }, { once: true });
      });
    }

    // é‡ç½®å¼¹çª—
    function resetPopups() {
      const popupLayer = document.getElementById("popup-layer");
      popupLayer.innerHTML = "";
      localMusic.pause();
      localMusic.currentTime = 0;
    }
  </script>
</body>

</html>
